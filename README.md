# ansible-my-shell

Процесс настройки состоит из нескольких этапов:

Установка всего необходимого мне ПО.
Создание пользователей и настройка ключей авторизации для SSH. Отключение регистрации по паролю и отключение root через ssh.
Настройка firewall – опционально.
Установка docker – опционально.
А теперь о каждом пункте детальный.

Подготовка конфигурации

Качаем локально мой репозиторий:

git clone https://github.com/alienrom/ansible-my-shell.git
В файле group_vars/all.yml прописан логин пользователя, которого необходимо создать. Так же, для него Вам понадобиться создать пароль с помощью команды mkpasswd --method=SHA-512, результат присвоить в переменную password. Обратите внимание, здесь может быть указано несколько пользователей. В файле public_keys/ssh_keys.pub разместите ключи ssh доступа для нового пользователя.

В массиве locales_gen укажите какие дополнительные локали необходимо создать на сервере.

В файле hosts прописаны хосты, которые мы будим настраивать. Идеальный варианта (как с DigitalOcean) у Вас уже установлен OS с пользователем root и авторизаций по SSH ключу.

Так же, стоит заметить, что мой рецепт пригоден только для Debian или Ubuntu Linux. Для других дистрибутивов его придется дописывать.

Установка необходимого ПО и создание пользователей

Для простоты, я создал Makefile, который содержит основные команды. Что бы выполнить установку и создать пользователей, достаточно ввести:

make install
Ansible установит весь нужный набор ПО, создаст пользователей, скопирует нужные конфигурационные файлы на сервер и подготовит все для работы:

ansible-playbook my-shell

Ниже представлен полный список ПО, которое будет установлено:

jq
zsh
git
vim
ntp
mtr
curl
sudo
tree
tmux
mosh
lsof
htop
iotop
iftop
iperf
ngrep
tcpdump
dnsutils
Теперь я могу подключаться к серверу и приступать к работе под своим пользователем в привычное окружение:

ansible my-shell

Настройка файрвола

Если нужно сразу сконфигурировать порты доступа к серверу, то для этого я предусмотрел секцию ufw в файле group_vars/all.yml. Здесь нужно включить firewall и прописать какие tcp и udp порты будут открыты.

Установка docker

Просто напишите

make install-docker

В.zshrc уже прописаны некоторые плагины и полезные сокращения. В частности:

myextip позволяет получить внешний адрес. Полезно, если сервер за NAT.
clr – просто очистка консоли.
hist10 – 10 наиболее часто вводимых в терминале команд.
hgrep – поиск по истории вводимых в терминале команд.
mynetcon – все открытые соединения с сервером.
mynetcon

tmux

Все команды выполняются после вызова префикса, который установлен у меня в Ctrl+a. К примеру, что бы создать новое окно, необходимо нажать Ctrl+a и потом c.

Запомните основные команды (после вызова префикса):

c – создать новое окно
s – разделить окно на два окна по горизонтали
v – разделить окно на два окна по вертикали
] – перейти к следующему окну
[ – вернуться к предыдущему окну
& – убить окно
w – показать список окон
, – переименовать окно
Escape – режим копирования. Теперь мы можем осуществлять навигацию по выводу терминала
m – включить режим мыши. Доступна работа с помощью мышки (изменить размеры окон, прокрутить листинг и т.д.)
M – отключить режим мыши
И главное, что бы создать новую сессию, необходимо выполнить tmux new в терминале. В любой момент мы можем отключиться нажав Ctrl+a и потом d (или даже закрыть ssh соединение), но, после возврата, все наши команды все так же будут выполняться внутри tmux сессии. Просмотреть список активных сессий – tmux ls и подключиться к одной из них – tmux attach -t 0, где 0 – это идентификатор сессии.
